<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driving Score Web App</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    video, canvas { width: 90%; max-width: 600px; margin-top: 10px; border: 2px solid #333; }
    #scoreBox, #speedBox { font-size: 1.5em; margin: 10px; }
    button { padding: 10px 20px; margin: 5px; font-size: 1em; }
    .history { margin-top: 20px; text-align: left; }
  </style>
</head>
<body>
  <h1>Driving Score Web App</h1>
  <div id="scoreBox">Score: <span id="score">100</span></div>
  <div id="speedBox">Speed: <span id="speed">0</span> km/h</div>
  <button onclick="saveToLocal()">Save Session</button>
  <button onclick="viewHistory()">View Session History</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score');
    const speedDisplay = document.getElementById('speed');
    let score = 100;
    let lastGeo = null;
    let sessionHistory = JSON.parse(localStorage.getItem('sessionHistory')) || [];

    // Load the Coco-SSD model for road sign detection
    let model;
    cocoSsd.load().then((loadedModel) => {
      model = loadedModel;
      console.log('Model loaded');
    });

    // Start camera
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    });

    // Lane Detection (simplified)
    function detectLane() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(0, canvas.height - 50, canvas.width, 50);
      let left = 0, right = 0;
      for (let x = 0; x < canvas.width; x++) {
        const index = (x + 25 * canvas.width) * 4;
        const brightness = (frame.data[index] + frame.data[index + 1] + frame.data[index + 2]) / 3;
        if (brightness > 200) {
          if (x < canvas.width / 2) left++;
          else right++;
        }
      }
      const diff = Math.abs(left - right);
      if (diff > 100) {
        score -= 1;
        if (score < 0) score = 0;
        scoreDisplay.textContent = score;
      }
      requestAnimationFrame(detectLane);
    }

    video.onloadedmetadata = () => {
      detectLane();
    };

    // Motion sensor (Turning/Braking)
    window.addEventListener("devicemotion", e => {
      const acc = e.accelerationIncludingGravity;
      // Detect hard turning or sudden braking
      if (Math.abs(acc.x) > 5 || acc.y < -10) {
        score -= 2;
        if (score < 0) score = 0;
        scoreDisplay.textContent = score;
      }
    });

    // GPS Speed detection
    navigator.geolocation.watchPosition(pos => {
      if (lastGeo) {
        const dx = pos.coords.latitude - lastGeo.latitude;
        const dy = pos.coords.longitude - lastGeo.longitude;
        const dt = (pos.timestamp - lastGeo.timestamp) / 1000;
        const dist = Math.sqrt(dx * dx + dy * dy) * 111000; // convert to meters
        const speed = dist / dt; // meters per second
        speedDisplay.textContent = (speed * 3.6).toFixed(1); // convert to km/h
      }
      lastGeo = pos.coords;
    });

    // Road Sign Detection
    function detectSigns() {
      if (model) {
        model.detect(video).then(predictions => {
          predictions.forEach(prediction => {
            // Detect specific road signs (e.g., stop signs)
            if (prediction.class === 'stop sign') {
              score -= 10;
              if (score < 0) score = 0;
              scoreDisplay.textContent = score;
            } else if (prediction.class === 'traffic light') {
              // Handle traffic lights (if needed)
            } else if (prediction.class === 'speed limit') {
              // Handle speed limit signs (if needed)
            }
          });
        });
      }
      requestAnimationFrame(detectSigns);
    }

    // Start road sign detection
    detectSigns();

    // Save session history to localStorage
    function saveToLocal() {
      const session = {
        score,
        speed: speedDisplay.textContent,
        date: new Date().toISOString(),
      };
      sessionHistory.push(session);
      localStorage.setItem('sessionHistory', JSON.stringify(sessionHistory));
      alert("Session saved!");
    }

    // View session history
    function viewHistory() {
      let historyText = "Session History:\n\n";
      sessionHistory.forEach((session, index) => {
        historyText += `Session ${index + 1}:\nScore: ${session.score}\nSpeed: ${session.speed}\nDate: ${session.date}\n\n`;
      });
      alert(historyText);
    }
  </script>
</body>
</html>
